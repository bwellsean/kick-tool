<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kick Chat Viewer</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <div class="container">
    <header>
      <h1>Kick Chat Viewer</h1>
    </header>

    <div class="controls">
      <input type="text" id="channel-name" placeholder="Enter channel name">
      <button id="find-channel">Find Channel</button>
      <button id="subscribe" disabled>Subscribe to Chat</button>
      <button id="clear-chat">Clear Chat</button>
    </div>

    <div class="main-content">
      <div class="channel-info" id="channel-info">
        <p>Enter a channel name to get started</p>
      </div>

      <div class="chat-container" id="chat-container">
        <div class="chat-messages" id="chat-messages"></div>
      </div>
    </div>

    <div id="debug-output" class="debug-output">
      <h3>Debug Output</h3>
    </div>
  </div>

  <script type="module">
    import { findChannelByName } from './channel-finder.js';
    import { subscribeToChatEvents } from './chat-subscriber.js';

    // Store current broadcaster ID
    let currentBroadcasterId = null;
    let pollingInterval = null;
    let lastMessageId = null;

    // Setup event listeners
    document.getElementById('find-channel').addEventListener('click', findChannel);
    document.getElementById('subscribe').addEventListener('click', subscribeToChat);
    document.getElementById('clear-chat').addEventListener('click', clearChat);

    async function findChannel() {
      const channelName = document.getElementById('channel-name').value;
      if (!channelName) {
        alert('Please enter a channel name');
        return;
      }

      try {
        const channel = await findChannelByName(channelName);
        if (channel) {
          currentBroadcasterId = channel.broadcaster_user_id;

          document.getElementById('channel-info').innerHTML = `
            <h2>${channel.slug}</h2>
            <p>Broadcaster ID: ${currentBroadcasterId}</p>
            <p>Description: ${channel.channel_description || 'No description'}</p>
            <p>Live: ${channel.stream?.is_live ? 'Yes' : 'No'}</p>
            <p>Stream Title: ${channel.stream_title || 'No title'}</p>
            <p>Category: ${channel.category?.name || 'No category'}</p>
            ${channel.banner_picture ? `<img src="${channel.banner_picture}" style="max-width:100%">` : ''}
          `;

          document.getElementById('subscribe').disabled = false;

          // Clear existing messages and start fresh
          document.getElementById('chat-messages').innerHTML = '';
          lastMessageId = null;

          // Start polling for messages right away
          startPollingMessages();
        } else {
          alert('Channel not found');
          document.getElementById('channel-info').innerHTML = '<p>No channel found with that name.</p>';
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error finding channel');
      }
    }

    async function subscribeToChat() {
      if (!currentBroadcasterId) {
        alert('No broadcaster selected');
        return;
      }

      try {
        await subscribeToChatEvents(currentBroadcasterId);
        alert('Successfully subscribed to chat events!');

        // Make sure we're polling for messages
        startPollingMessages();
      } catch (error) {
        console.error('Error:', error);
        alert('Error subscribing to chat: ' + error.message);
      }
    }

    function clearChat() {
      document.getElementById('chat-messages').innerHTML = '';
      lastMessageId = null;
    }

    function startPollingMessages() {
      // Clear any existing polling
      if (pollingInterval) {
        clearInterval(pollingInterval);
      }

      // Poll every 2 seconds
      pollingInterval = setInterval(fetchMessages, 2000);

      // Initial fetch
      fetchMessages();
    }

    async function fetchMessages() {
      try {
        const url = new URL('/api/messages', window.location.origin);

        // Add broadcaster ID if we have one
        if (currentBroadcasterId) {
          url.searchParams.append('broadcaster_id', currentBroadcasterId);
        }

        const response = await fetch(url.toString());
        const data = await response.json();

        if (data.success && data.messages && data.messages.length > 0) {
          // Process only new messages
          const messages = data.messages;
          let newMessages = messages;

          if (lastMessageId) {
            // Filter to only show messages we haven't seen
            newMessages = messages.filter(msg => msg.id !== lastMessageId &&
              !document.querySelector(`[data-message-id="${msg.id}"]`));
          }

          if (newMessages.length > 0) {
            // Update last message ID
            lastMessageId = messages[0].id;

            // Add new messages to the chat
            newMessages.forEach(addMessageToChat);
          }
        }
      } catch (error) {
        console.error('Error fetching messages:', error);
      }
    }

    function addMessageToChat(message) {
      const chatMessages = document.getElementById('chat-messages');

      // Create message element
      const messageEl = document.createElement('div');
      messageEl.className = 'chat-message';
      messageEl.dataset.messageId = message.id;

      // Format timestamp
      const time = new Date(message.timestamp);
      const timeStr = time.toLocaleTimeString();

      // Create HTML content
      messageEl.innerHTML = `
        <span class="timestamp">[${timeStr}]</span>
        <span class="username">${message.sender_display_name || message.sender_name}:</span>
        <span class="content">${escapeHtml(message.content)}</span>
      `;

      // Add to container
      chatMessages.appendChild(messageEl);

      // Scroll to bottom
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Helper to escape HTML in user content
    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // Debug console output
    const originalConsoleLog = console.log;
    const originalConsoleError = console.error;

    console.log = function (...args) {
      originalConsoleLog.apply(console, args);
      const debugDiv = document.getElementById('debug-output');
      debugDiv.innerHTML += `<div class="log">${args.map(arg =>
        typeof arg === 'object' ? JSON.stringify(arg) : arg).join(' ')}</div>`;
      debugDiv.scrollTop = debugDiv.scrollHeight;
    };

    console.error = function (...args) {
      originalConsoleError.apply(console, args);
      const debugDiv = document.getElementById('debug-output');
      debugDiv.innerHTML += `<div class="error">${args.map(arg =>
        typeof arg === 'object' ? JSON.stringify(arg) : arg).join(' ')}</div>`;
      debugDiv.scrollTop = debugDiv.scrollHeight;
    };
  </script>
</body>

</html>