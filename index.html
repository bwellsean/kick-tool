<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Web Page</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
</head>
<body>
  <h1>Kick Chat Viewer</h1>

  <div class="controls">
    <input type="text" id="channel-name" placeholder="Enter channel name">
    <button id="find-channel">Find Channel</button>
    <button id="subscribe" disabled>Subscribe to Chat</button>
  </div>

  <div id="channel-info">
    <!-- Channel info will be displayed here -->
  </div>

  <div id="chat-container">
    <!-- Chat messages will be displayed here -->
  </div>

  <script type="module">
    import { makeApiRequest } from './app.js';
    import { findChannelByName } from './channel-finder.js';
    import { subscribeToChatEvents } from './chat-subscriber.js';

    let currentBroadcasterId = null;

    document.getElementById('find-channel').addEventListener('click', async () => {
      const channelName = document.getElementById('channel-name').value;
      if (!channelName) {
        alert('Please enter a channel name');
        return;
      }

      try {
        const channel = await findChannelByName(channelName);
        if (channel) {
          currentBroadcasterId = channel.user_id;

          document.getElementById('channel-info').innerHTML = `
              <h2>${channel.user.username}</h2>
              <p>Broadcaster ID: ${currentBroadcasterId}</p>
              <p>Followers: ${channel.followers_count}</p>
            `;

          document.getElementById('subscribe').disabled = false;
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error finding channel');
      }
    });

    document.getElementById('subscribe').addEventListener('click', async () => {
      if (!currentBroadcasterId) {
        alert('No broadcaster selected');
        return;
      }

      try {
        await subscribeToChatEvents(currentBroadcasterId);
        alert('Successfully subscribed to chat events! Check the console for webhook data.');
      } catch (error) {
        console.error('Error:', error);
        alert('Error subscribing to chat');
      }
    });

    // Function to add a chat message to the UI
    window.addChatMessage = function (username, message) {
      const chatContainer = document.getElementById('chat-container');
      const messageElement = document.createElement('div');
      messageElement.className = 'chat-message';
      messageElement.innerHTML = `<span class="username">${username}:</span> ${message}`;
      chatContainer.appendChild(messageElement);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    };

    let lastMessageCheck = 0;

    // Poll for new messages every 3 seconds
    setInterval(async () => {
      try {
        const response = await fetch('/api/get-messages');
        const data = await response.json();

        // Process only new messages
        const newMessages = data.messages.filter(msg => {
          const msgTime = new Date(msg.timestamp).getTime();
          return msgTime > lastMessageCheck;
        });

        if (newMessages.length > 0) {
          newMessages.forEach(msg => {
            window.addChatMessage(msg.username, msg.message);
          });

          // Update the timestamp
          lastMessageCheck = new Date().getTime();
        }
      } catch (error) {
        console.error('Error fetching messages:', error);
      }
    }, 3000);

    // Add this inside your script tag
    const debugDiv = document.createElement('div');
    debugDiv.id = 'debug-output';
    debugDiv.style.marginTop = '20px';
    debugDiv.style.padding = '10px';
    debugDiv.style.border = '1px solid #ccc';
    debugDiv.style.backgroundColor = '#f8f8f8';
    debugDiv.style.maxHeight = '300px';
    debugDiv.style.overflow = 'auto';
    debugDiv.innerHTML = '<h3>Debug Output</h3>';
    document.body.appendChild(debugDiv);

    // Override console.log and console.error
    const originalConsoleLog = console.log;
    const originalConsoleError = console.error;

    console.log = function(...args) {
      originalConsoleLog.apply(console, args);
      debugDiv.innerHTML += `<div style="color:black">${args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : arg).join(' ')}</div>`;
      debugDiv.scrollTop = debugDiv.scrollHeight;
    };

    console.error = function(...args) {
      originalConsoleError.apply(console, args);
      debugDiv.innerHTML += `<div style="color:red">${args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : arg).join(' ')}</div>`;
      debugDiv.scrollTop = debugDiv.scrollHeight;
    };
  </script>
  <script type="module" src="app.js"></script>
</body>
</html>