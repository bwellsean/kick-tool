<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kick Chat Viewer</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <div class="container">
    <header>
      <h1>Kick Chat Viewer</h1>
    </header>

    <div class="controls">
      <input type="text" id="channel-name" placeholder="Enter channel name">
      <button id="find-channel">Find Channel</button>
      <button id="subscribe" disabled>Subscribe to Chat</button>
      <button id="clear-chat">Clear Chat</button>
    </div>

    <div class="channel-status" id="channel-status">
      <!-- Status will be shown here -->
    </div>

    <div class="main-content">
      <div class="channel-info" id="channel-info">
        <p>Enter a channel name to get started</p>
      </div>

      <div class="chat-container">
        <div class="chat-header">
          <h3>Chat Messages</h3>
          <span id="message-count">0 messages</span>
        </div>
        <div class="chat-messages" id="chat-messages"></div>
      </div>
    </div>

    <div id="debug-output" class="debug-output">
      <h3>Debug Output</h3>
    </div>
  </div>

  <script type="module">
    import { findChannelByName } from './channel-finder.js';
    import { subscribeToChatEvents } from './chat-subscriber.js';

    // Store current broadcaster ID
    let currentBroadcasterId = null;
    let pollingInterval = null;
    let lastMessageCount = 0;
    let isSubscribed = false;

    // Setup event listeners
    document.getElementById('find-channel').addEventListener('click', findChannel);
    document.getElementById('subscribe').addEventListener('click', subscribeToChat);
    document.getElementById('clear-chat').addEventListener('click', clearChat);

    async function findChannel() {
      const channelName = document.getElementById('channel-name').value;
      if (!channelName) {
        alert('Please enter a channel name');
        return;
      }

      // Update status
      updateStatus('Searching for channel...');

      try {
        const channel = await findChannelByName(channelName);
        if (channel) {
          currentBroadcasterId = channel.broadcaster_user_id;

          // Update channel info
          document.getElementById('channel-info').innerHTML = `
            <h2>${channel.slug}</h2>
            <p>Broadcaster ID: ${currentBroadcasterId}</p>
            <p>Description: ${channel.channel_description || 'No description'}</p>
            <p>Live: ${channel.stream?.is_live ? 'Yes' : 'No'}</p>
            <p>Stream Title: ${channel.stream_title || 'No title'}</p>
            <p>Category: ${channel.category?.name || 'No category'}</p>
            ${channel.banner_picture ? `<img src="${channel.banner_picture}" style="max-width:100%">` : ''}
          `;

          // Enable subscribe button
          document.getElementById('subscribe').disabled = false;

          // Clear existing messages
          document.getElementById('chat-messages').innerHTML = '';
          lastMessageCount = 0;
          updateStatus('Channel found! Click "Subscribe to Chat" to begin');

          // Start polling for messages
          startPollingMessages();
        } else {
          updateStatus('Channel not found');
          document.getElementById('channel-info').innerHTML = '<p>No channel found with that name.</p>';
        }
      } catch (error) {
        console.error('Error:', error);
        updateStatus('Error finding channel');
      }
    }

    async function subscribeToChat() {
      if (!currentBroadcasterId) {
        alert('No broadcaster selected');
        return;
      }

      // Update status
      updateStatus('Subscribing to chat events...');
      document.getElementById('subscribe').disabled = true;

      try {
        const response = await subscribeToChatEvents(currentBroadcasterId);
        console.log('Subscription response:', response);

        // Update UI
        document.getElementById('subscribe').textContent = 'Subscribed âœ“';
        updateStatus('Subscribed to chat events!');
        isSubscribed = true;

        // Make sure polling is active
        startPollingMessages();
      } catch (error) {
        console.error('Error:', error);
        document.getElementById('subscribe').disabled = false;
        updateStatus('Error subscribing to chat: ' + error.message);
      }
    }

    function clearChat() {
      document.getElementById('chat-messages').innerHTML = '';
      lastMessageCount = 0;
      document.getElementById('message-count').textContent = '0 messages';
      updateStatus(isSubscribed ? 'Chat cleared' : 'Chat cleared. Not subscribed to events.');
    }

    function startPollingMessages() {
      // Clear any existing interval
      if (pollingInterval) {
        clearInterval(pollingInterval);
      }

      // Initial fetch
      fetchMessages();

      // Set up polling every 3 seconds
      pollingInterval = setInterval(fetchMessages, 3000);
    }

    async function fetchMessages() {
      if (!currentBroadcasterId) return;

      try {
        // Build URL with broadcaster ID
        const url = new URL('/api/messages', window.location.origin);
        url.searchParams.append('broadcaster_id', currentBroadcasterId);

        // Fetch messages
        const response = await fetch(url.toString());
        const data = await response.json();

        if (data.success) {
          // Update message count
          const count = data.count;
          document.getElementById('message-count').textContent = `${count} message${count !== 1 ? 's' : ''}`;

          // Check if there are new messages
          if (count > lastMessageCount) {
            // Get only the new messages
            const newMessages = data.messages.slice(0, count - lastMessageCount);

            // Add new messages to chat
            newMessages.forEach(addMessageToChat);

            // Update count
            lastMessageCount = count;

            // Update status if this is the first message
            if (count === 1) {
              updateStatus('First message received!');
            }
          }
        }
      } catch (error) {
        console.error('Error fetching messages:', error);
      }
    }

    function addMessageToChat(message) {
      const chatMessages = document.getElementById('chat-messages');

      // Create message element
      const messageEl = document.createElement('div');
      messageEl.className = 'chat-message';
      messageEl.dataset.messageId = message.id;

      // Format timestamp
      const time = new Date(message.timestamp);
      const timeStr = time.toLocaleTimeString();

      // Create HTML content
      messageEl.innerHTML = `
        <span class="timestamp">[${timeStr}]</span>
        <span class="username">${escapeHtml(message.sender_display_name || message.sender_name)}:</span>
        <span class="content">${escapeHtml(message.content)}</span>
      `;

      // Add to container
      chatMessages.appendChild(messageEl);

      // Scroll to bottom
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function updateStatus(message) {
      const statusEl = document.getElementById('channel-status');
      statusEl.textContent = message;
    }

    // Helper to escape HTML
    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // Initialize
    updateStatus('Enter a channel name to get started');
  </script>
</body>

</html>